<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¸ªäººè‡ªç•™åœ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --bg-paper: #fcfaf2; }
        body {
            background-color: var(--bg-paper);
            background-size: cover; background-position: center; background-repeat: no-repeat;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden; height: 100dvh; display: flex; flex-direction: column;
            position: fixed; width: 100%; transition: background 0.5s ease;
            /* å…³é”®ä¿®æ”¹ï¼šç¦æ­¢å…¨å±€é•¿æŒ‰å¼¹å‡ºèœå• */
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            user-select: none;
        }

        /* å…è®¸è¾“å…¥æ¡†å¯ä»¥é€‰æ‹©æ–‡å­—å’Œè°ƒèµ·èœå•ï¼Œç¡®ä¿æ­£å¸¸ä½¿ç”¨ */
        input, textarea {
            -webkit-touch-callout: default !important;
            -webkit-user-select: text !important;
            user-select: text !important;
        }

        .danmu-item {
            position: absolute; cursor: grab;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.05); 
            max-width: 80vw;
            min-width: 60px; 
            white-space: nowrap;
            z-index: 10;
            transform: rotate(0deg);
            transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* å¼¹å¹•ç¦æ­¢é•¿æŒ‰ */
            -webkit-touch-callout: none;
        }
        
        #warningZone {
            position: absolute; inset: 6px; border: 2px dashed #ef4444;
            background: rgba(239, 68, 68, 0.04); pointer-events: none;
            z-index: 5; opacity: 0; transition: opacity 0.2s ease; border-radius: 16px;
        }
        .show-warning #warningZone { opacity: 1; }
        .is-dragging { animation: none !important; opacity: 0.8; transform: scale(1.02) rotate(0deg) !important; z-index: 1000 !important; transition: none !important; }
        .archive-item-box { position: absolute; left: 16px; bottom: 16px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border: 2px dashed #cbd5e1 !important; color: #64748b; transition: all 0.2s; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .archive-item-box.drag-over { transform: scale(1.2); background: #e2e8f0; border-color: #3b82f6 !important; }
        #detailCard { position: fixed; z-index: 1100; display: none; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        #mainDisplay { flex: 1; position: relative; overflow: hidden; }
        .footer-area { background: rgba(255,255,255,0.9); border-top: 1px solid rgba(0,0,0,0.05); z-index: 100; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        .card-enter { animation: cardScale 0.2s ease-out forwards; }
        @keyframes cardScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-container { width: 90%; max-width: 400px; min-width: 320px; margin: auto; }
        #viewToggle { width: 44px; height: 44px; min-width: 44px; font-size: 14px; flex-shrink: 0; }
        .pos-selector { display: flex; background: #f1f5f9; border-radius: 8px; padding: 2px; gap: 2px; }
        .pos-btn { font-size: 9px; padding: 2px 8px; border-radius: 6px; color: #94a3b8; transition: all 0.2s; font-weight: bold; }
        .pos-btn.active { background: white; color: #334155; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .timeline-container { position: relative; width: 100%; transition: all 0.3s; }
        .timeline-line { position: absolute; top: 0; bottom: 0; width: 2px; background: rgba(0,0,0,0.1); z-index: 0; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .line-left .timeline-line { left: 8px; }
        .line-center .timeline-line { left: 50%; transform: translateX(-50%); }
        .line-right .timeline-line { right: 8px; left: auto; }
        .timeline-date-group { margin-bottom: 30px; position: relative; width: 100%; display: flex; }
        .line-left .timeline-date-group { justify-content: flex-start; }
        .line-center .timeline-date-group { justify-content: center; }
        .line-right .timeline-date-group { justify-content: flex-end; }
        .timeline-date-label { display: inline-block; background: #94a3b8; color: white; font-size: 10px; padding: 2px 10px; border-radius: 10px; font-weight: bold; z-index: 2; position: relative; }
        .timeline-item { position: relative; margin-bottom: 24px; z-index: 1; display: flex; flex-direction: column; }
        .timeline-dot { position: absolute; width: 10px; height: 10px; background: #cbd5e1; border-radius: 50%; border: 2px solid white; top: 12px; transition: all 0.3s; z-index: 3; }
        
        .timeline-info { font-size: 10px; color: #94a3b8; margin-top: 4px; display: flex; gap: 4px; align-items: center; white-space: nowrap; }
        .line-left .timeline-info { flex-direction: row; }
        .line-right .timeline-info { flex-direction: row-reverse; }
        .line-center .timeline-item-left .timeline-info { flex-direction: row-reverse; }
        .line-center .timeline-item-right .timeline-info { flex-direction: row; }

        .timeline-bubble { background: white; padding: 10px 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); display: inline-block; max-width: 100%; border: 1px solid rgba(0,0,0,0.02); }
        .timeline-content { font-size: 14px; color: #334155; line-height: 1.5; word-break: break-all; }
        .line-left .timeline-item { padding-left: 24px; align-items: flex-start; text-align: left; }
        .line-left .timeline-dot { left: 4px; top: 12px; }
        .line-left .timeline-bubble { border-radius: 4px 16px 16px 16px; }
        .line-right .timeline-item { padding-right: 24px; align-items: flex-end; text-align: right; }
        .line-right .timeline-dot { right: 4px; top: 12px; }
        .line-right .timeline-bubble { border-radius: 16px 4px 16px 16px; }
        .line-center .timeline-item { width: 50%; }
        .line-center .timeline-item-left { margin-right: 50%; padding-right: 20px; align-items: flex-end; text-align: right; }
        .line-center .timeline-item-left .timeline-dot { right: -5px; top: 12px; }
        .line-center .timeline-item-right { margin-left: 50%; padding-left: 20px; align-items: flex-start; text-align: left; }
        .line-center .timeline-item-right .timeline-dot { left: -5px; top: 12px; }
        
        .archive-list { max-height: 40vh; overflow-y: auto; }
        .archive-list-item { border-bottom: 1px solid #f1f5f9; padding: 12px 4px; }
        .restore-btn { font-size: 10px; font-weight: bold; color: #3b82f6; background: #eff6ff; padding: 4px 8px; border-radius: 6px; }
        .lab-color-item { transition: all 0.2s; border: 2px solid transparent; padding: 2px; border-radius: 50%; }
        .lab-color-item.active { border-color: #334155; transform: scale(1.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        #templateContainer { display: none; padding: 8px 16px 0; gap: 8px; overflow-x: auto; white-space: nowrap; }
        .template-tag { display: inline-block; padding: 4px 12px; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 11px; color: #64748b; cursor: pointer; transition: all 0.2s; }
        .template-tag:active { transform: scale(0.95); background: #f8fafc; }

        .time-refresh-btn { background: #f8fafc; border: 1px solid #f1f5f9; padding: 4px 10px; font-family: monospace; font-size: 10px; color: #94a3b8; border-radius: 6px; transition: all 0.2s; white-space: nowrap; }
        .time-refresh-btn:active { background: #eff6ff; color: #3b82f6; transform: scale(0.95); }

        #timeRefreshConfirm { position: fixed; inset: 0; z-index: 6000; background: rgba(0,0,0,0.2); display: none; align-items: center; justify-content: center; backdrop-filter: blur(1px); }
        .confirm-box-mini { background: white; border-radius: 16px; padding: 20px 16px; width: 200px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #f1f5f9; text-align: center; }

        .style-random-tag { border-style: dashed !important; background: #f8fafc !important; }
        
        #noteInput {
            padding-right: 12px !important; 
            transition: background 0.3s, color 0.3s, border 0.3s; 
            border-style: solid;
        }
    </style>
</head>
<body id="bodyRoot">

    <header id="headerBar" class="p-3 glass-panel border-b flex flex-col gap-2 shrink-0">
        <div class="flex items-center gap-2 flex-nowrap w-full">
            <input type="text" id="searchInput" placeholder="æœç´¢å…³é”®è¯..." class="min-w-0 flex-1 px-4 py-2.5 rounded-full border border-gray-200 text-sm outline-none bg-white/50 focus:bg-white transition-all">
            <button id="viewToggle" class="bg-white border border-gray-100 rounded-full font-bold active:scale-90 shadow-sm flex items-center justify-center text-slate-700">è½´</button>
        </div>
        <div id="searchStats" class="px-2 flex items-center justify-between text-[10px] text-gray-400 font-medium">
            <div class="flex items-center gap-1 bg-gray-50/50 px-2 py-0.5 rounded-full border border-gray-100">å…³é”®è¯: <span id="statKeyword" class="text-slate-600">å…¨éƒ¨</span></div>
            <div id="posSelectorContainer" class="hidden flex items-center gap-2">
                <div class="pos-selector">
                    <button onclick="setLinePos('left')" id="btnPosLeft" class="pos-btn">å·¦</button>
                    <button onclick="setLinePos('center')" id="btnPosCenter" class="pos-btn active">ä¸­</button>
                    <button onclick="setLinePos('right')" id="btnPosRight" class="pos-btn">å³</button>
                </div>
            </div>
            <div onclick="openExport()" class="flex items-center gap-1 bg-slate-50/50 px-2 py-0.5 rounded-full border border-slate-100 text-slate-500 cursor-pointer active:scale-95 transition-transform">å·²è®°å½•: <span id="statCount" class="font-bold text-slate-800">0</span>æ¬¡</div>
        </div>
    </header>

    <main id="mainDisplay">
        <div id="warningZone"></div>
        <div id="danmuWall" class="w-full h-full relative"></div>
        <div id="timelineWall" class="w-full h-full overflow-y-auto hidden pb-24 px-4 pt-6 no-scrollbar"></div>
    </main>

    <div id="detailCard" class="bg-white rounded-2xl border shadow-2xl p-4 w-64 card-enter">
        <textarea id="detailEditArea" class="w-full text-xs text-slate-700 leading-relaxed break-words font-medium mb-3 bg-slate-50 p-2 rounded-lg border-none outline-none focus:ring-1 focus:ring-blue-100 resize-none overflow-hidden" placeholder="ä¿®æ”¹å†…å®¹..."></textarea>
        <div class="flex items-center justify-end gap-3 border-t border-gray-100 pt-3 text-[10px] text-slate-400">
            <span id="detailLoc" class="font-bold truncate max-w-[80px] mr-auto">ğŸ“ åœ°ç‚¹</span>
            <button id="timeRefreshBtn" class="time-refresh-btn" onclick="showRefreshConfirm()">ğŸ”„ 2024-01-01 00:00</button>
        </div>
        <div class="mt-3 flex justify-end">
            <button onclick="closeAndSaveDetail()" class="text-[10px] text-blue-500 font-bold px-4 py-1.5 bg-blue-50 rounded-lg active:scale-95">å®Œæˆ</button>
        </div>
    </div>

    <div id="timeRefreshConfirm">
        <div class="confirm-box-mini">
            <p class="text-[11px] font-bold text-slate-600 mb-3">ç¡®å®šåˆ·æ–°ä¸ºå½“å‰æ—¶é—´å—ï¼Ÿ</p>
            <div class="flex gap-2">
                <button onclick="hideRefreshConfirm()" class="flex-1 py-1 bg-gray-100 text-slate-400 rounded-lg text-[10px]">å–æ¶ˆ</button>
                <button onclick="doRefreshTime()" class="flex-1 py-1 bg-blue-500 text-white rounded-lg text-[10px]">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="exportModal" class="fixed inset-0 bg-black/60 z-[5000] hidden flex items-center justify-center p-4" onclick="closeExport()">
        <div class="bg-white rounded-[2rem] p-6 shadow-2xl card-enter modal-container" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-800 text-sm">ğŸ“‹ å¯¼å‡ºé¢„è§ˆ</h3>
                <div class="flex gap-2">
                    <button id="captureBtn" onclick="captureFullScreenshot()" class="text-[10px] text-rose-500 font-bold px-2 py-1 bg-rose-50 rounded-lg">æˆªå›¾</button>
                    <button onclick="downloadTXT()" class="text-[10px] text-slate-500 font-bold px-2 py-1 bg-slate-50 rounded-lg">TXT</button>
                </div>
            </div>
            <div id="exportList" class="archive-list no-scrollbar"></div>
            <button onclick="closeExport()" class="w-full mt-4 py-3 bg-slate-800 text-white rounded-2xl text-xs font-bold shadow-lg active:scale-95">è¿”å›</button>
        </div>
    </div>

    <div id="bgSettingsModal" class="fixed inset-0 bg-black/60 z-[4000] hidden flex items-center justify-center p-4" onclick="closeBgSettings()">
        <div class="bg-white rounded-[2.5rem] p-7 shadow-2xl card-enter modal-container" onclick="event.stopPropagation()">
            <h3 class="font-bold text-slate-800 mb-6 text-center text-sm">ğŸ¨ èƒŒæ™¯è®¾å®š</h3>
            <div class="space-y-5">
                <div id="bgPicker" class="flex justify-center"></div>
                <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-2xl border border-gray-100">
                    <input type="text" id="bgInput" placeholder="URLæˆ–é¢œè‰²ä»£ç " class="flex-1 bg-transparent text-xs outline-none text-slate-600 font-mono">
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="resetBg()" class="py-3 flex-1 bg-gray-100 text-slate-400 rounded-2xl text-xs font-bold active:scale-95">è¿˜åŸ</button>
                    <button onclick="applyBg()" class="py-3 flex-1 bg-slate-800 text-white rounded-2xl text-xs font-bold shadow-lg active:scale-95">å®Œæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="danmuStyleModal" class="fixed inset-0 bg-black/60 z-[4000] hidden flex items-center justify-center p-4" onclick="closeDanmuStyle()">
        <div class="bg-white rounded-[2rem] p-6 shadow-2xl card-enter modal-container" onclick="event.stopPropagation()">
            <h3 class="font-bold text-slate-800 mb-5 text-center text-sm">ğŸï¸ æ ·å¼å®éªŒå®¤</h3>
            <div class="space-y-6">
                <div class="flex flex-col items-center gap-4 bg-gray-50 py-4 rounded-2xl border border-gray-100/50">
                    <div class="flex gap-12">
                        <div onclick="switchLabTarget('text')" class="flex flex-col items-center gap-1 cursor-pointer">
                            <span class="text-[10px] font-bold text-slate-400">æ–‡å­—</span>
                            <div id="textPreviewItem" class="lab-color-item active"><div id="textPreview" class="w-8 h-8 rounded-full border-2 border-white shadow-sm"></div></div>
                        </div>
                        <div onclick="switchLabTarget('bg')" class="flex flex-col items-center gap-1 cursor-pointer">
                            <span class="text-[10px] font-bold text-slate-400">èƒŒæ™¯</span>
                            <div id="bgPreviewItem" class="lab-color-item"><div id="danmuBgPreview" class="w-8 h-8 rounded-full border-2 border-white shadow-sm"></div></div>
                        </div>
                    </div>
                    <div id="labPicker" class="flex justify-center"></div>
                </div>
                <div class="px-2">
                    <div class="flex justify-between mb-3"><span class="text-[11px] font-bold text-slate-600">è¾¹æ¡†ç²—ç»†</span><span id="borderValDisplay" class="text-[11px] font-mono text-slate-400">1.5px</span></div>
                    <input type="range" id="styleBorderSize" min="0" max="5" step="0.5" value="1.5" class="w-full h-1.5 bg-gray-100 rounded-lg appearance-none accent-slate-800" oninput="updateLabStylePreview()">
                </div>
                <div class="flex gap-3 pt-1">
                    <button onclick="resetDanmuStyle()" class="py-3 flex-1 bg-gray-100 text-slate-400 rounded-2xl text-xs font-bold active:scale-95">é»˜è®¤</button>
                    <button onclick="saveStyleSettings()" class="py-3 flex-1 bg-slate-800 text-white rounded-2xl text-xs font-bold shadow-lg active:scale-95">ç¡®å®šå¹¶åº”ç”¨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="archiveModal" class="fixed inset-0 bg-black/60 z-[5000] hidden flex items-center justify-center p-4" onclick="closeArchive()">
        <div class="bg-white rounded-[2rem] p-6 shadow-2xl card-enter modal-container" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-800 text-sm">ğŸ“¦ å½’æ¡£è®°å½•</h3>
                <button onclick="showConfirmModal()" class="text-[10px] text-red-400 font-bold px-2 py-1 bg-red-50 rounded-lg">æ¸…ç©º</button>
            </div>
            <div id="archiveList" class="archive-list no-scrollbar"></div>
            <button onclick="closeArchive()" class="w-full mt-4 py-3 bg-slate-800 text-white rounded-2xl text-xs font-bold shadow-lg active:scale-95">å…³é—­è¯¦æƒ…</button>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black/40 z-[6000] hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeConfirmModal()">
        <div class="bg-white rounded-[2.5rem] p-8 shadow-2xl card-enter modal-container" onclick="event.stopPropagation()">
            <div class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-xl">âš ï¸</span></div>
            <h3 class="text-center font-bold text-slate-800 mb-2">ç¡®è®¤æ°¸ä¹…åˆ é™¤ï¼Ÿ</h3>
            <p class="text-center text-[11px] text-slate-400 mb-6 leading-relaxed">æ­¤æ“ä½œå°†æ¸…ç©ºå½’æ¡£ç®±å†…æ‰€æœ‰è®°å½•ã€‚</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="py-3 flex-1 bg-gray-100 text-slate-500 rounded-2xl text-xs font-bold active:scale-95">å†æƒ³æƒ³</button>
                <button onclick="clearAllArchived()" class="py-3 flex-1 bg-red-500 text-white rounded-2xl text-xs font-bold shadow-lg active:scale-95">ç¡®è®¤æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <footer id="footerBar" class="footer-area shadow-2xl">
        <div id="templateContainer" class="no-scrollbar">
            <div class="template-tag" onclick="useTemplate('2026-')">â³å¹´åº¦è®¡åˆ’</div>
            <div class="template-tag" onclick="useTemplate('ä»Šæ—¥-')">â›±ï¸æ¯æ—¥</div>
            <div class="template-tag" onclick="useTemplate('æ­¤åˆ»-')">ğŸ“– ç¬é—´</div>
            <div class="template-tag style-random-tag" onclick="randomizeInputStyle()">ğŸ”„ éšæœºæ ·å¼</div>
        </div>
        
        <div class="flex items-center justify-between px-4 py-1 text-[10px] text-gray-400">
            <div class="flex items-center gap-1">ğŸ“ <input type="text" id="locInput" value="æŸæ—¶æŸåœ°çš„æˆ‘" class="bg-transparent border-none outline-none font-bold text-slate-500" style="width:100px;"></div>
            <div id="dateDisplay" class="font-mono"></div>
        </div>
        <div class="px-4 pb-2 pt-1 flex items-center gap-3">
            <div class="flex-1 relative h-10">
                <textarea id="noteInput" rows="1" maxlength="100" placeholder="å¼€å§‹è®°å½•..." class="w-full h-full bg-gray-50 px-3 py-2 rounded-xl border border-gray-100 text-sm resize-none outline-none"></textarea>
            </div>
            
            <button id="submitBtn" class="bg-slate-800 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg active:scale-90 shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
            </button>
        </div>
    </footer>

    <script>
        const defaultNotes = [
            { id: 'def_1', content: 'æ¬¢è¿æ¥åˆ°ä½ çš„ä¸ªäººè‡ªç•™åœ° â›±ï¸', timestamp: Date.now(), addr: 'å…‰é˜´æ·±å¤„', isArchived: false, style: { text: '#ffffff', bg: '#1e293b', border: 2 }, x: 30, y: 100 },
            { id: 'def_2', content: 'é•¿æŒ‰å‘é€æŒ‰é’®å¯ä»¥å¼€å¯æ ·å¼å®éªŒå®¤ âœ¨', timestamp: Date.now() - 10000, addr: 'æ–°æ‰‹æ‘', isArchived: false, style: { text: '#3b82f6', bg: '#eff6ff', border: 1.5 }, x: 80, y: 200 },
            { id: 'def_3', content: 'æ‹–åŠ¨æˆ‘åˆ°å·¦ä¸‹è§’å¯ä»¥å½’æ¡£å“¦ ğŸ“¦', timestamp: Date.now() - 20000, addr: 'å°è´´å£«', isArchived: false, style: { text: '#ec4899', bg: '#fdf2f8', border: 1.5 }, x: 40, y: 300 }

        ];

        let localData = JSON.parse(localStorage.getItem('fave_notes_v12')) || [];
        let notes = localData.length === 0 ? defaultNotes : localData;
        let viewMode = 'wall';
        let linePos = 'center';
        let currentLaboratoryStyle = JSON.parse(localStorage.getItem('fave_lab_style_v12')) || { text: '#334155', bg: '#ffffff', border: 1.5 };
        let labTarget = 'text';
        let bgColorPicker, labColorPicker;
        let activeNoteId = null; 
        let currentActiveTimestamp = null;
        let isCurrentlyRandom = false; 

        function showRefreshConfirm() { document.getElementById('timeRefreshConfirm').style.display = 'flex'; }
        function hideRefreshConfirm() { document.getElementById('timeRefreshConfirm').style.display = 'none'; }
        
        function doRefreshTime() {
            const now = new Date(); 
            currentActiveTimestamp = now.getTime();
            const dateStr = now.toLocaleDateString().replace(/\//g, '-');
            const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: false});
            document.getElementById('timeRefreshBtn').innerText = `ğŸ”„ ${dateStr} ${timeStr}`;
            const editArea = document.getElementById('detailEditArea');
            if(!editArea.value.endsWith('âœ…')) {
                editArea.value += 'âœ…';
                autoResizeEdit(editArea);
            }
            hideRefreshConfirm();
        }

        function useTemplate(text) { const input = document.getElementById('noteInput'); input.value = text; input.focus(); }
        function isInvalidPosition(x, y) { const mainRect = document.getElementById('mainDisplay').getBoundingClientRect(); return (y < mainRect.top + 15 || y > mainRect.bottom - 15 || x < mainRect.left + 15 || x > mainRect.right - 15); }
        function getRandomPos() { const margin = 60; return { x: margin + Math.random() * (window.innerWidth - margin * 2 - 100), y: margin + 100 + Math.random() * (window.innerHeight - margin * 2 - 250) }; }

        function bindInteraction(el, note) {
            let isMoving = false, startX, startY, initialX, initialY;
            const onStart = (e) => {
                const t = e.touches ? e.touches[0] : e;
                startX = t.clientX; startY = t.clientY; initialX = el.offsetLeft; initialY = el.offsetTop;
                document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove, { passive: false }); document.addEventListener('touchend', onEnd);
            };
            const onMove = (e) => {
                const t = e.touches ? e.touches[0] : e; const dx = t.clientX - startX, dy = t.clientY - startY;
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) { 
                    if (!isMoving) { isMoving = true; el.classList.add('is-dragging'); } 
                    el.style.left = (initialX + dx) + 'px'; el.style.top = (initialY + dy) + 'px'; 
                    const rect = el.getBoundingClientRect();
                    if (isInvalidPosition(rect.left + rect.width / 2, rect.top + rect.height / 2)) { document.body.classList.add('show-warning'); } else { document.body.classList.remove('show-warning'); }
                    const box = document.getElementById('archiveTarget');
                    if(box) { const r = box.getBoundingClientRect(); if(t.clientX > r.left - 20 && t.clientX < r.right + 20 && t.clientY > r.top - 20 && t.clientY < r.bottom + 20) { box.classList.add('drag-over'); } else { box.classList.remove('drag-over'); } }
                }
            };
            const onEnd = (e) => {
                document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd);
                document.body.classList.remove('show-warning');
                if (isMoving) { 
                    el.classList.remove('is-dragging');
                    const rect = el.getBoundingClientRect();
                    if (isInvalidPosition(rect.left + rect.width / 2, rect.top + rect.height / 2)) {
                        const newPos = getRandomPos(); el.style.left = newPos.x + 'px'; el.style.top = newPos.y + 'px';
                        note.x = newPos.x; note.y = newPos.y;
                    } else { 
                        if(el.offsetLeft + el.offsetWidth > window.innerWidth - 10) el.style.left = (window.innerWidth - el.offsetWidth - 10) + 'px';
                        note.x = el.offsetLeft; note.y = el.offsetTop; 
                    }
                    const box = document.getElementById('archiveTarget');
                    if(box) { box.classList.remove('drag-over'); const r = box.getBoundingClientRect(); const t = e.changedTouches ? e.changedTouches[0] : e; if(t.clientX > r.left - 20 && t.clientX < r.right + 20 && t.clientY > r.top - 20 && t.clientY < r.bottom + 20) { note.isArchived = true; saveAndRender(); return; } }
                    saveToLocal(); 
                } else { showDetailCard(e.clientX || e.changedTouches[0].clientX, e.clientY || e.changedTouches[0].clientY, note); }
            };
            el.addEventListener('mousedown', onStart); el.addEventListener('touchstart', onStart, { passive: false });
        }

        function showDetailCard(x, y, note) {
            const card = document.getElementById('detailCard'); const editArea = document.getElementById('detailEditArea'); const timeBtn = document.getElementById('timeRefreshBtn');
            activeNoteId = note.id; currentActiveTimestamp = note.timestamp; 
            const d = new Date(note.timestamp); const dateStr = d.toLocaleDateString().replace(/\//g, '-'); const timeStr = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: false});
            document.getElementById('detailLoc').innerText = `ğŸ“ ${note.addr}`; 
            timeBtn.innerText = `ğŸ”„ ${dateStr} ${timeStr}`; 
            editArea.value = note.content; card.style.display = 'block'; autoResizeEdit(editArea); 
            card.style.left = Math.min(Math.max(10, x - 128), window.innerWidth - 270) + 'px'; card.style.top = (y < 200 ? y + 20 : y - 180) + 'px';
        }

        function autoResizeEdit(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }
        function closeAndSaveDetail() { if (activeNoteId) { const newContent = document.getElementById('detailEditArea').value.trim(); const note = notes.find(n => n.id === activeNoteId); if (note) { note.content = newContent; note.timestamp = currentActiveTimestamp; saveAndRender(); } } document.getElementById('detailCard').style.display = 'none'; activeNoteId = null; }

        function render() {
            const kwd = document.getElementById('searchInput').value.trim();
            document.getElementById('statKeyword').innerText = kwd || "å…¨éƒ¨";
            const wall = document.getElementById('danmuWall'), timeline = document.getElementById('timelineWall'), pSel = document.getElementById('posSelectorContainer');
            let filtered = notes.filter(n => !n.isArchived && n.content.toLowerCase().includes(kwd.toLowerCase()));
            document.getElementById('statCount').innerText = filtered.length;
            wall.innerHTML = ''; timeline.innerHTML = '';
            if(viewMode === 'wall') {
                wall.classList.remove('hidden'); timeline.classList.add('hidden'); pSel.classList.add('hidden');
                filtered.forEach(note => {
                    const el = document.createElement('div'); const s = note.style || { text: '#334155', bg: '#ffffff', border: 1.5 };
                    el.className = `danmu-item px-4 py-2 border rounded-2xl text-xs font-medium`;
                    el.style.backgroundColor = s.bg; el.style.color = s.text; el.style.borderWidth = s.border + 'px'; el.style.borderColor = s.text;
                    el.style.left = (note.x || 50) + 'px'; el.style.top = (note.y || 150) + 'px'; el.innerText = note.content;
                    bindInteraction(el, note); wall.appendChild(el);
                });
                addArchiveBox(notes.filter(n => n.isArchived).length);
            } else {
                wall.classList.add('hidden'); timeline.classList.remove('hidden'); pSel.classList.remove('hidden');
                const container = document.createElement('div'); container.className = `timeline-container line-${linePos}`; 
                const line = document.createElement('div'); line.className = 'timeline-line'; container.appendChild(line);
                let lastDate = ""; let itemIndex = 0; 
                filtered.sort((a,b) => b.timestamp - a.timestamp).forEach((note) => { 
                    const d = new Date(note.timestamp); const dateStr = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`; 
                    if(dateStr !== lastDate) { const dateGroup = document.createElement('div'); dateGroup.className = 'timeline-date-group'; dateGroup.innerHTML = `<div class="timeline-date-label">${dateStr}</div>`; container.appendChild(dateGroup); lastDate = dateStr; itemIndex = 0; } 
                    const item = document.createElement('div'); let sideClass = (linePos === 'center' ? (itemIndex % 2 === 0 ? 'timeline-item-left' : 'timeline-item-right') : ''); item.className = `timeline-item ${sideClass}`; const timeStr = `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; 
                    item.innerHTML = `<div class="timeline-dot"></div><div class="timeline-bubble" onclick="showDetailCardFromTimeline(event, '${note.id}')"><div class="timeline-content">${note.content}</div></div><div class="timeline-info"><span class="font-mono">${timeStr}</span><span>ğŸ“</span><span>${note.addr}</span></div>`; 
                    container.appendChild(item); itemIndex++; 
                }); timeline.appendChild(container);
            }
        }

        async function captureFullScreenshot() { 
            const kwd = document.getElementById('searchInput').value.trim(); const filtered = notes.filter(n => !n.isArchived && n.content.toLowerCase().includes(kwd.toLowerCase())); if(filtered.length === 0) return; const btn = document.getElementById('captureBtn'); const originalText = btn.innerText; btn.innerText = "ç”Ÿæˆä¸­..."; const offScreenContainer = document.createElement('div'); offScreenContainer.style.width = '400px'; offScreenContainer.style.background = '#ffffff'; offScreenContainer.style.padding = '20px'; offScreenContainer.style.position = 'fixed'; offScreenContainer.style.left = '-10000px'; offScreenContainer.innerHTML = `<div style="font-weight: bold; font-size: 18px; margin-bottom: 20px;">è®°å½•åˆ—è¡¨</div>` + filtered.map(note => `<div style="border-bottom: 1px solid #f1f5f9; padding: 12px 0;"><div style="font-size: 14px; margin-bottom: 4px;">${note.content}</div><div style="font-size: 10px; color: #94a3b8; display: flex; justify-content: space-between;"><span>ğŸ“ ${note.addr}</span><span>${new Date(note.timestamp).toLocaleString()}</span></div></div>`).join(''); document.body.appendChild(offScreenContainer); 
            try { const canvas = await html2canvas(offScreenContainer, { backgroundColor: "#ffffff", scale: 2 }); const link = document.createElement('a'); link.download = `è®°å½•_${Date.now()}.png`; link.href = canvas.toDataURL("image/png"); link.click(); } catch (err) { console.error("æˆªå›¾å¤±è´¥:", err); } finally { document.body.removeChild(offScreenContainer); btn.innerText = originalText; } 
        }

        function saveToLocal() { localStorage.setItem('fave_notes_v12', JSON.stringify(notes)); }
        function saveAndRender() { saveToLocal(); render(); }
        
        function handleSend() { 
            const input = document.getElementById('noteInput'), content = input.value.trim(); 
            const loc = document.getElementById('locInput').value.trim() || "æ­¤åˆ»çš„å¿ƒé‡Œ"; 
            if(!content) return; 
            const pos = getRandomPos(); 
            notes.unshift({ id: 'n_' + Date.now(), content, timestamp: Date.now(), addr: loc, isArchived: false, style: {...currentLaboratoryStyle}, x: pos.x, y: pos.y }); 
            saveAndRender(); 
            input.value = ''; 
            input.focus();
            if(isCurrentlyRandom) {
                applyStyleToInput(currentLaboratoryStyle);
                input.placeholder = "å½“å‰æ ·å¼ï¼šå·²é”å®šéšæœº";
            } else {
                input.placeholder = "è®°å½•ç¬é—´...";
                resetInputStyle(); 
            }
        }

        function resetInputStyle() {
            const input = document.getElementById('noteInput'); 
            input.style.background = ""; 
            input.style.color = ""; 
            input.style.border = "";
            isCurrentlyRandom = false; 
        }
        
        function toggleView() { viewMode = viewMode === 'wall' ? 'timeline' : 'wall'; document.getElementById('viewToggle').innerText = viewMode === 'wall' ? 'è½´' : 'å¢™'; render(); }
        function setLinePos(pos) { linePos = pos; document.querySelectorAll('.pos-btn').forEach(btn => btn.classList.remove('active')); document.getElementById(`btnPos${pos.charAt(0).toUpperCase() + pos.slice(1)}`).classList.add('active'); render(); }
        function showDetailCardFromTimeline(e, id) { const note = notes.find(n => n.id === id); if(note) showDetailCard(e.clientX, e.clientY, note); }
        function addArchiveBox(count) { const el = document.createElement('div'); el.id = 'archiveTarget'; el.className = 'archive-item-box px-4 py-2 rounded-full text-[11px] font-bold flex items-center gap-2'; el.innerHTML = `<span>ğŸ“¦</span><span>å½’æ¡£</span><span class="bg-slate-200 px-1.5 py-0.5 rounded-full text-[10px]">${count}</span>`; el.onclick = openArchive; document.getElementById('danmuWall').appendChild(el); }
        function openArchive() { const list = document.getElementById('archiveList'), archived = notes.filter(n => n.isArchived); list.innerHTML = archived.length ? '' : '<div class="text-center text-xs text-gray-400 py-8">æ‹–æ‹½å¼¹å¹•è‡³æ­¤å½’æ¡£...</div>'; archived.forEach(note => { const item = document.createElement('div'); item.className = 'archive-list-item flex justify-between items-center gap-3'; item.innerHTML = `<div class="flex-1 min-w-0"><div class="text-[11px] text-slate-700 truncate">${note.content}</div><div class="text-[8px] text-slate-400 font-mono">${new Date(note.timestamp).toLocaleString()}</div></div><button onclick="restoreNote('${note.id}')" class="restore-btn">è¿˜åŸ</button>`; list.appendChild(item); }); document.getElementById('archiveModal').classList.remove('hidden'); }
        function restoreNote(id) { const n = notes.find(x => x.id === id); if(n) { n.isArchived = false; const pos = getRandomPos(); n.x = pos.x; n.y = pos.y; saveAndRender(); openArchive(); } }
        function showConfirmModal() { document.getElementById('confirmModal').classList.remove('hidden'); }
        function closeConfirmModal() { document.getElementById('confirmModal').classList.add('hidden'); }
        function clearAllArchived() { notes = notes.filter(n => !n.isArchived); saveAndRender(); closeConfirmModal(); closeArchive(); }
        function closeArchive() { document.getElementById('archiveModal').classList.add('hidden'); }
        function closeExport() { document.getElementById('exportModal').classList.add('hidden'); }
        function openExport() { const list = document.getElementById('exportList'); const kwd = document.getElementById('searchInput').value.trim(); const filtered = notes.filter(n => !n.isArchived && n.content.toLowerCase().includes(kwd.toLowerCase())); list.innerHTML = filtered.length ? '' : '<div class="text-center text-xs text-gray-400 py-8">æš‚æ— åŒ¹é…è®°å½•...</div>'; filtered.forEach(note => { const item = document.createElement('div'); item.className = 'archive-list-item'; item.innerHTML = `<div class="text-[11px] text-slate-700 leading-snug">${note.content}</div><div class="text-[8px] text-slate-400 font-mono mt-1 flex justify-between"><span>ğŸ“ ${note.addr}</span><span>${new Date(note.timestamp).toLocaleString()}</span></div>`; list.appendChild(item); }); document.getElementById('exportModal').classList.remove('hidden'); }
        function downloadTXT() { const kwd = document.getElementById('searchInput').value.trim(); const filtered = notes.filter(n => !n.isArchived && n.content.toLowerCase().includes(kwd.toLowerCase())); const text = filtered.map(n => `[${new Date(n.timestamp).toLocaleString()}] @${n.addr}: ${n.content}`).join('\n'); if (!text) return; const blob = new Blob([text], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `è®°å½•_${Date.now()}.txt`; a.click(); }
        function updateDateDisplay() { const now = new Date(); document.getElementById('dateDisplay').innerText = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`; }
        function initBg() { const savedBg = localStorage.getItem('fave_bg_v12') || '#fcfaf2'; applyBgStyle(savedBg); document.getElementById('bgInput').value = savedBg; }
        function applyBg() { const val = document.getElementById('bgInput').value.trim(); if (val) { applyBgStyle(val); localStorage.setItem('fave_bg_v12', val); } closeBgSettings(); }
        function resetBg() { applyBgStyle('#fcfaf2'); localStorage.removeItem('fave_bg_v12'); closeBgSettings(); }
        function closeBgSettings() { document.getElementById('bgSettingsModal').classList.add('hidden'); }
        function applyBgStyle(val) { const body = document.getElementById('bodyRoot'); if (val.startsWith('http')) { body.style.backgroundImage = `url('${val}')`; body.style.backgroundColor = 'transparent'; } else { body.style.backgroundImage = 'none'; body.style.backgroundColor = val; } }

        function applyStyleToInput(s) {
            const input = document.getElementById('noteInput');
            input.style.backgroundColor = s.bg;
            input.style.color = s.text;
            input.style.borderColor = s.text;
            input.style.borderWidth = s.border + 'px';
        }

        function randomizeInputStyle() {
            const h = Math.floor(Math.random() * 360);
            const bgColor = `hsl(${h}, ${50 + Math.random() * 40}%, ${92 + Math.random() * 5}%)`;
            const textColor = `hsl(${h}, ${60 + Math.random() * 30}%, ${30 + Math.random() * 20}%)`;
            const borderSize = (1 + Math.random() * 2.5).toFixed(1);
            currentLaboratoryStyle = { text: textColor, bg: bgColor, border: parseFloat(borderSize) };
            applyStyleToInput(currentLaboratoryStyle);
            isCurrentlyRandom = true; 
            document.getElementById('noteInput').placeholder = "å½“å‰æ ·å¼ï¼šå·²é”å®šéšæœº"; 
            initLabUI();
            if(labColorPicker) labColorPicker.color.set(labTarget === 'text' ? textColor : bgColor);
        }

        function updateLabStylePreview() {
            const s = currentLaboratoryStyle;
            s.text = document.getElementById('textPreview').style.backgroundColor;
            s.bg = document.getElementById('danmuBgPreview').style.backgroundColor;
            s.border = parseFloat(document.getElementById('styleBorderSize').value);
            document.getElementById('borderValDisplay').innerText = s.border + 'px';
            applyStyleToInput(s); 
            isCurrentlyRandom = false; 
            document.getElementById('noteInput').placeholder = "è®°å½•ç¬é—´...";
        }

        function initLabUI() { 
            const s = currentLaboratoryStyle; 
            document.getElementById('textPreview').style.backgroundColor = s.text; 
            document.getElementById('danmuBgPreview').style.backgroundColor = s.bg; 
            document.getElementById('styleBorderSize').value = s.border; 
            document.getElementById('borderValDisplay').innerText = s.border + 'px'; 
        }

        function saveStyleSettings() { 
            localStorage.setItem('fave_lab_style_v12', JSON.stringify(currentLaboratoryStyle)); 
            closeDanmuStyle(); render(); 
        }

        function resetDanmuStyle() { 
            currentLaboratoryStyle = { text: '#334155', bg: '#ffffff', border: 1.5 }; 
            initLabUI(); applyStyleToInput(currentLaboratoryStyle); saveStyleSettings(); 
        }

        function closeDanmuStyle() { document.getElementById('danmuStyleModal').classList.add('hidden'); }
        function switchLabTarget(target) { 
            labTarget = target; 
            document.getElementById('textPreviewItem').classList.toggle('active', target === 'text'); 
            document.getElementById('bgPreviewItem').classList.toggle('active', target === 'bg'); 
            labColorPicker.color.set(target === 'text' ? currentLaboratoryStyle.text : currentLaboratoryStyle.bg);
        }

        function initPickers() { 
            bgColorPicker = new iro.ColorPicker("#bgPicker", { width: 180, color: localStorage.getItem('fave_bg_v12') || "#fcfaf2" }); 
            bgColorPicker.on('color:change', (color) => { document.getElementById('bgInput').value = color.hexString; applyBgStyle(color.hexString); }); 
            labColorPicker = new iro.ColorPicker("#labPicker", { width: 180, color: currentLaboratoryStyle.text }); 
            labColorPicker.on('color:change', (color) => { 
                if(labTarget === 'text') {
                    document.getElementById('textPreview').style.backgroundColor = color.hexString;
                    currentLaboratoryStyle.text = color.hexString;
                } else {
                    document.getElementById('danmuBgPreview').style.backgroundColor = color.hexString;
                    currentLaboratoryStyle.bg = color.hexString;
                }
                updateLabStylePreview(); 
            }); 
        }

        const main = document.getElementById('mainDisplay'); let bgTimer;
        const handleBgStart = (e) => { 
            const isItem = e.target.closest('.danmu-item, .timeline-bubble, .archive-item-box, .pos-selector, .modal-container, .archive-list-item, #detailCard, .template-tag, #timeRefreshConfirm'); 
            if(!isItem) { 
                bgTimer = setTimeout(() => document.getElementById('bgSettingsModal').classList.remove('hidden'), 800); 
                closeAndSaveDetail(); 
                document.getElementById('templateContainer').style.display = 'none'; 
            } 
        };

        document.addEventListener('DOMContentLoaded', () => {
            initPickers(); initLabUI(); initBg(); render(); updateDateDisplay();
            const sBtn = document.getElementById('submitBtn'), nInput = document.getElementById('noteInput'), dEdit = document.getElementById('detailEditArea');
            const tContainer = document.getElementById('templateContainer');
            sBtn.onclick = handleSend;
            document.getElementById('viewToggle').onclick = toggleView;
            document.getElementById('searchInput').oninput = render;

            nInput.onfocus = () => { tContainer.style.display = 'flex'; };
            nInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } };
            dEdit.oninput = (e) => autoResizeEdit(e.target); 
            main.oncontextmenu = (e) => e.preventDefault(); main.onmousedown = handleBgStart; main.ontouchstart = handleBgStart;
            main.onmouseup = () => clearTimeout(bgTimer); main.ontouchend = () => clearTimeout(bgTimer);
            let btnTimer;
            const startLab = () => btnTimer = setTimeout(() => { document.getElementById('danmuStyleModal').classList.remove('hidden'); initLabUI(); }, 800);
            sBtn.onmousedown = startLab; sBtn.ontouchstart = startLab;
            sBtn.onmouseup = () => clearTimeout(btnTimer); sBtn.ontouchend = () => clearTimeout(btnTimer);
        });
    </script>
</body>
</html>
